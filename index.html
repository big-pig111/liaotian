<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'; img-src 'self' https: data: blob:; font-src 'self' https: data:; connect-src 'self' https: wss:;">
    <title>Bonk Chat - Solana's Favorite Meme Community</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onValue, off, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA5Z5ieEbAcfQX0kxGSn9ldGXhzvAwx_8M",
            authDomain: "chat-294cc.firebaseapp.com",
            databaseURL: "https://chat-294cc-default-rtdb.firebaseio.com",
            projectId: "chat-294cc",
            storageBucket: "chat-294cc.firebasestorage.app",
            messagingSenderId: "913615304269",
            appId: "1:913615304269:web:0274ffaccb8e6b678e4e04",
            measurementId: "G-SJR9NDW86B"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const storage = getStorage(app);

        // Make Firebase available globally with all necessary functions
        window.firebase = { 
            auth, 
            database, 
            storage,
            // Add the functions we need
            ref, push, onValue, off, set, get, child,
            signInAnonymously, onAuthStateChanged, signOut,
            storageRef, uploadBytes, getDownloadURL
        };
    </script>
    <script>
        // é…ç½®Tailwindè‡ªå®šä¹‰é¢œè‰²å’Œå­—ä½“
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bonk: {
                            orange: '#FF9500',
                            light: '#FFB74D',
                            dark: '#E65100'
                        },
                        solana: {
                            blue: '#00FFA3',
                            dark: '#00BFA5'
                        },
                        chat: {
                            bg: '#1A1A1A',
                            bubble: '#F5F5F5',
                            bubbleSelf: '#FF9500',
                            text: '#FFFFFF',
                            textDark: '#333333'
                        }
                    },
                    fontFamily: {
                        nunito: ['Nunito', 'sans-serif'],
                        comic: ['Comic Sans MS', 'cursive']
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-small': 'bounce 1s infinite',
                        'wiggle': 'wiggle 1s ease-in-out infinite'
                    },
                    keyframes: {
                        wiggle: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' }
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }
            .message-appear {
                animation: messageAppear 0.3s ease-out forwards;
            }
            @keyframes messageAppear {
                from {
                    transform: translateY(10px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            .bonk-highlight {
                animation: bonkHighlight 1s ease-in-out;
            }
            @keyframes bonkHighlight {
                0%, 100% { color: theme('colors.chat.text'); }
                50% { color: theme('colors.bonk.orange'); }
            }
        }
        
        /* å…¨å±€æ ·å¼ - é˜²æ­¢é¡µé¢æ»šåŠ¨ */
        html, body {
            overflow: hidden;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        /* æ¶ˆæ¯åŒºåŸŸæ»šåŠ¨æ ·å¼ */
        #messageArea {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; /* iOSå¹³æ»‘æ»šåŠ¨ */
        }
        
        /* ç¡®ä¿ä¾§è¾¹æ ä¸æ»šåŠ¨ */
        #sidebar, #communityPanel {
            overflow: hidden;
        }
        
        /* ä¾§è¾¹æ å†…éƒ¨æ»šåŠ¨åŒºåŸŸ */
        #sidebar nav, #communityPanel > div:not(:last-child) {
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        #sidebar nav::-webkit-scrollbar, 
        #communityPanel > div:not(:last-child)::-webkit-scrollbar {
            display: none;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-chat-bg text-chat-text font-nunito h-screen flex flex-col overflow-hidden">
    <div class="flex flex-1 overflow-hidden">
        <!-- å·¦ä¾§å¯¼èˆªæ  - æ¡Œé¢ç«¯ -->
        <aside id="sidebar" class="hidden md:flex flex-col w-60 bg-chat-bg border-r border-gray-700 z-20 transition-all duration-300 ease-in-out">
            <!-- Bonk Logoå’Œæœç´¢ -->
            <div class="p-4 border-b border-gray-700">
                <div class="flex items-center space-x-2 mb-4">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center overflow-hidden">
                        <img src="1.png" alt="Bonk Chat Logo" class="w-full h-full object-cover">
                    </div>
                    <h1 class="text-2xl font-bold font-comic text-white">Bonk<span class="text-bonk-orange">Chat</span></h1>
                </div>
                <div class="relative">
                    <input type="text" placeholder="æ‰¾å¥½å‹/è¯é¢˜..." 
                        class="w-full bg-gray-800 rounded-full py-2 px-4 pl-10 text-sm focus:outline-none focus:ring-2 focus:ring-bonk-orange">
                    <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
            </div>

            <!-- å¯¼èˆªèœå• -->
            <nav class="flex-1 overflow-y-auto p-2" style="scrollbar-width: none; -ms-overflow-style: none;">
                <ul class="space-y-1">
                    <li>
                        <a href="#" class="flex items-center space-x-3 p-3 rounded-lg bg-gray-800 text-white">
                            <i class="fa fa-home text-xl w-6 text-center"></i>
                            <span>é¦–é¡µ</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 transition-colors">
                            <i class="fa fa-comments text-xl w-6 text-center"></i>
                            <span>èŠå¤©åˆ—è¡¨</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 transition-colors">
                            <i class="fa fa-fire text-xl w-6 text-center"></i>
                            <span>ç¤¾åŒºè¯é¢˜</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 transition-colors">
                            <i class="fa fa-star text-xl w-6 text-center"></i>
                            <span>æ”¶è—</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-800 transition-colors">
                            <i class="fa fa-bar-chart text-xl w-6 text-center"></i>
                            <span>å¸‚åœºåŠ¨æ€</span>
                        </a>
                    </li>
                </ul>

                <!-- çƒ­é—¨è¯é¢˜æ ‡ç­¾ -->
                <div class="mt-6">
                    <h3 class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">çƒ­é—¨è¯é¢˜</h3>
                    <div class="flex flex-wrap gap-2 p-3">
                        <span class="bg-gray-800 text-white text-xs px-3 py-1 rounded-full">#Bonkæš´æ¶¨</span>
                        <span class="bg-gray-800 text-white text-xs px-3 py-1 rounded-full">#Solana</span>
                        <span class="bg-gray-800 text-white text-xs px-3 py-1 rounded-full">#NFT</span>
                        <span class="bg-gray-800 text-white text-xs px-3 py-1 rounded-full">#Meme</span>
                        <span class="bg-gray-800 text-white text-xs px-3 py-1 rounded-full">#Web3</span>
                    </div>
                </div>
            </nav>

            <!-- åº•éƒ¨ - ç™»å½•å’Œé’±åŒ…è¿æ¥ -->
            <div class="p-4 border-t border-gray-700 space-y-3">
                <!-- ç™»å½•æŒ‰é’® -->
                <button id="loginBtn" class="w-full bg-gradient-to-r from-bonk-orange to-bonk-dark text-white rounded-lg py-2.5 px-4 font-medium transition-all duration-300 hover:shadow-lg hover:shadow-bonk-orange/25 flex items-center justify-center space-x-2">
                    <i class="fa fa-sign-in"></i>
                    <span>ç™»å½•èŠå¤©</span>
                </button>
                
                <!-- é’±åŒ…è¿æ¥æŒ‰é’® -->
                <button id="connectWallet" class="w-full bg-transparent border-2 border-bonk-orange text-bonk-orange hover:bg-bonk-orange hover:text-white rounded-lg py-2.5 px-4 font-medium transition-colors flex items-center justify-center space-x-2">
                    <i class="fa fa-wallet"></i>
                    <span>è¿æ¥é’±åŒ…</span>
                </button>
                
                                    <!-- ç™»å½•æˆåŠŸåæ˜¾ç¤º -->
                    <div id="userProfile" class="hidden">
                        <div class="flex items-center space-x-3 p-2 bg-gray-800 rounded-lg">
                            <div class="w-10 h-10 rounded-full bg-solana-blue flex items-center justify-center overflow-hidden" id="userAvatarContainer">
                                <i class="fa fa-user text-chat-text-dark font-bold" id="userAvatarIcon"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium" id="userName">Bonkç”¨æˆ·</p>
                                <p class="text-xs text-gray-400" id="userStatus">åœ¨çº¿</p>
                            </div>
                            <button id="logoutBtn" class="text-gray-400 hover:text-red-400 transition-colors">
                                <i class="fa fa-sign-out"></i>
                            </button>
                        </div>
                    </div>
                
                <!-- é’±åŒ…è¿æ¥æˆåŠŸåæ˜¾ç¤º -->
                <div id="walletConnected" class="hidden">
                    <div class="flex items-center space-x-3 p-2 bg-gray-800 rounded-lg">
                        <div class="w-10 h-10 rounded-full bg-solana-blue flex items-center justify-center">
                            <i class="fa fa-check text-chat-text-dark font-bold"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium">é’±åŒ…å·²è¿æ¥</p>
                            <p class="text-xs text-gray-400">0x71C...f8D2</p>
                        </div>
                        <button id="disconnectWalletBtn" class="text-gray-400 hover:text-red-400 transition-colors">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- ä¸­é—´èŠå¤©ä¸»åŒº -->
        <main class="flex-1 flex flex-col overflow-hidden bg-gray-900">
            <!-- é¡¶éƒ¨èŠå¤©æ ‡é¢˜æ  -->
            <header class="h-16 flex items-center justify-between p-4 border-b border-gray-700 bg-chat-bg">
                <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
                <button id="mobileMenuBtn" class="md:hidden p-2 rounded-full hover:bg-gray-800">
                    <i class="fa fa-bars text-xl"></i>
                </button>
                
                <!-- èŠå¤©æ ‡é¢˜ -->
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 overflow-hidden">
                        <img src="1.png" alt="BonkçœŸçˆ±ç²‰ç¾¤" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <h2 class="font-bold">BonkçœŸçˆ±ç²‰ç¾¤</h2>
                        <p class="text-xs text-gray-400 online-count">è¿æ¥ä¸­...</p>
                    </div>
                </div>
                
                <!-- å³ä¾§åŠŸèƒ½æŒ‰é’® -->
                <div class="flex items-center space-x-2">
                    <button class="p-2 rounded-full hover:bg-gray-800 transition-colors">
                        <i class="fa fa-phone text-gray-300"></i>
                    </button>
                    <button class="p-2 rounded-full hover:bg-gray-800 transition-colors">
                        <i class="fa fa-cog text-gray-300"></i>
                    </button>
                    <button class="p-2 rounded-full hover:bg-gray-800 transition-colors">
                        <i class="fa fa-ellipsis-v text-gray-300"></i>
                    </button>
                </div>
            </header>

            <!-- æ¶ˆæ¯æµåŒºåŸŸ -->
            <div id="messageArea" class="flex-1 overflow-y-auto p-4 space-y-6 scrollbar-hide relative" style="scroll-behavior: smooth;">
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="flex justify-center">
                    <div class="bg-gray-800 text-gray-300 text-sm px-4 py-2 rounded-full">
                        <i class="fa fa-rocket mr-2"></i>
                        æ¬¢è¿æ¥åˆ°BonkèŠå¤©å®¤ï¼ğŸš€
                </div>
                    </div>
                </div>

            <!-- æ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’®ï¼Œç§»é™¤absolute/fixedï¼Œç”±JSåŠ¨æ€å®šä½ -->
            <button id="scrollToBottomBtn" style="z-index:9999;display:none;" class="bg-bonk-orange hover:bg-bonk-dark text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg transition-all duration-300 opacity-0 pointer-events-none">
                <i class="fa fa-chevron-down"></i>
            </button>



            <!-- åº•éƒ¨è¾“å…¥åŒº -->
            <div class="p-4 border-t border-gray-700 bg-chat-bg">
                <div class="flex items-end space-x-2">
                    <!-- è¡¨æƒ…æŒ‰é’® -->
                    <button id="emojiBtn" class="p-2 rounded-full hover:bg-gray-800 transition-colors">
                        <i class="fa fa-smile-o text-xl text-gray-300"></i>
                    </button>
                    
                    <!-- å›¾ç‰‡æŒ‰é’® -->
                    <button id="imageUploadBtn" class="p-2 rounded-full hover:bg-gray-800 transition-colors">
                        <i class="fa fa-image text-xl text-gray-300"></i>
                    </button>
                    <input type="file" id="imageInput" accept="image/*" class="hidden">
                    
                    <!-- NFTæŒ‰é’® -->
                    <button class="p-2 rounded-full hover:bg-gray-800 transition-colors">
                        <i class="fa fa-diamond text-xl text-gray-300"></i>
                    </button>
                    
                    <!-- è¾“å…¥æ¡† -->
                    <div class="flex-1 relative">
                        <textarea id="messageInput" placeholder="è¯´ç‚¹Bonkç›¸å…³çš„..." 
                            class="w-full bg-gray-800 rounded-full py-3 px-4 text-sm focus:outline-none focus:ring-2 focus:ring-bonk-orange resize-none"
                            rows="1"></textarea>
                    </div>
                    
                    <!-- å‘é€æŒ‰é’® -->
                    <button id="sendBtn" class="bg-bonk-orange hover:bg-bonk-dark text-white rounded-full w-11 h-11 flex items-center justify-center transition-colors">
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </div>
                
                <!-- è¡¨æƒ…é¢æ¿ - é»˜è®¤éšè— -->
                <div id="emojiPanel" class="hidden mt-3 bg-gray-800 rounded-xl p-3 grid grid-cols-7 gap-2 max-h-48 overflow-y-auto scrollbar-hide">
                    <button class="emoji-btn p-2 hover:bg-gray-700 rounded-lg">ğŸ˜‚</button>
                    <button class="emoji-btn p-2 hover:bg-gray-700 rounded-lg">ğŸš€</button>
                    <button class="emoji-btn p-2 hover:bg-gray-700 rounded-lg">ğŸ¶</button>
                    <button class="emoji-btn p-2 hover:bg-gray-700 rounded-lg">ğŸ’</button>
                    <button class="emoji-btn p-2 hover:bg-gray-700 rounded-lg">ğŸš¨</button>
                    <button class="emoji-btn p-2 hover:bg-gray-700 rounded-lg">ğŸ”¥</button>
                    <button class="emoji-btn p-2 hover:bg-gray-700 rounded-lg">ğŸ¦¾</button>
                    <button class="emoji-btn p-2 hover:bg-gray-700 rounded-lg">ğŸ’°</button>
                    <button class="emoji-btn p-2 hover:bg-gray-700 rounded-lg">ğŸ¤¯</button>
                    <button class="emoji-btn p-2 hover:bg-gray-700 rounded-lg">ğŸš€</button>
                    <button class="emoji-btn p-2 hover:bg-gray-700 rounded-lg">ğŸ™Œ</button>
                    <button class="emoji-btn p-2 hover:bg-gray-700 rounded-lg">ğŸš€</button>
                    <button class="emoji-btn p-2 hover:bg-gray-700 rounded-lg">ğŸ‰</button>
                    <button class="emoji-btn p-2 hover:bg-gray-700 rounded-lg">Bonk!</button>
                </div>
            </div>
        </main>

        <!-- å³ä¾§ç¤¾åŒºä¿¡æ¯æ  - æ¡Œé¢ç«¯ -->
        <aside id="communityPanel" class="hidden lg:flex flex-col w-72 bg-chat-bg border-l border-gray-700 z-10">
            <!-- ç¾¤æˆå‘˜åˆ—è¡¨ -->
            <div class="p-4 border-b border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold">ç¾¤æˆå‘˜</h3>
                    <span class="bg-gray-800 text-gray-300 text-xs px-2 py-1 rounded-full online-count">è¿æ¥ä¸­...</span>
                </div>
                
                <div class="relative">
                    <input type="text" placeholder="æœç´¢æˆå‘˜..." 
                        class="w-full bg-gray-800 rounded-full py-2 px-4 pl-10 text-sm focus:outline-none focus:ring-2 focus:ring-bonk-orange">
                    <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
            </div>
            
            <!-- æˆå‘˜åˆ—è¡¨ -->
            <div class="flex-1 overflow-y-auto p-2" style="scrollbar-width: none; -ms-overflow-style: none;">
                <ul class="space-y-1" id="memberList">
                    <!-- æˆå‘˜åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    <li class="text-center py-4">
                        <div class="w-6 h-6 border-2 border-gray-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
                        <p class="text-xs text-gray-400 mt-2">åŠ è½½æˆå‘˜ä¸­...</p>
                    </li>
                </ul>
            </div>
            
            <!-- Bonkå®æ—¶æ•°æ® -->
            <div class="p-4 border-t border-gray-700">
                <h3 class="font-bold mb-3">Bonkå®æ—¶æ•°æ®</h3>
                <div class="bg-gray-800 rounded-xl p-3">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-400">å½“å‰ä»·æ ¼</span>
                        <span class="text-sm font-semibold">$0.00006241</span>
                    </div>
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-sm text-gray-400">24h æ¶¨è·Œå¹…</span>
                        <span class="text-sm font-semibold text-green-500">+12.34%</span>
                    </div>
                    <div class="h-16 mb-2">
                        <!-- ç®€å•çš„ä»·æ ¼èµ°åŠ¿å›¾ -->
                        <canvas id="priceChart"></canvas>
                    </div>
                    <a href="#" class="text-bonk-orange hover:text-bonk-light text-sm flex items-center justify-center py-2 border border-bonk-orange rounded-lg transition-colors">
                        æŸ¥çœ‹è¯¦æƒ…
                        <i class="fa fa-arrow-right ml-1"></i>
                    </a>
                </div>
            </div>
        </aside>
    </div>

    <!-- é’±åŒ…è¿æ¥æˆåŠŸæç¤º -->
    <div id="walletToast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-bonk-orange text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-3 z-50 hidden">
        <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center">
            <i class="fa fa-dog text-bonk-orange animate-bounce-small"></i>
        </div>
        <div>
            <p class="font-medium">å·²è¿æ¥Solanaé’±åŒ…</p>
            <p class="text-xs">ç°åœ¨å¯ä»¥å‘é€NFTå’ŒæŸ¥çœ‹èº«ä»½æ ‡è¯†äº†</p>
        </div>
    </div>

    <!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="relative max-w-4xl max-h-full p-4">
            <button id="closeImageModal" class="absolute top-4 right-4 text-white text-2xl hover:text-gray-300 z-10">
                <i class="fa fa-times"></i>
            </button>
            <img id="modalImage" src="" alt="æŸ¥çœ‹å›¾ç‰‡" class="max-w-full max-h-full object-contain">
        </div>
    </div>

    <!-- ç™»å½•å¼¹çª— -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-chat-bg rounded-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="loginModalContent">
            <!-- å…³é—­æŒ‰é’® -->
            <button id="closeLoginModal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                <i class="fa fa-times text-xl"></i>
            </button>
            
            <!-- å¼¹çª—å¤´éƒ¨ -->
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-bonk-orange to-bonk-dark rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-dog text-white text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">æ¬¢è¿æ¥åˆ°BonkèŠå¤©</h2>
                <p class="text-gray-400">åŠ å…¥Solanaæœ€æ´»è·ƒçš„memeç¤¾åŒº</p>
            </div>
            
            <!-- ç™»å½•é€‰é¡¹ -->
            <div class="space-y-4">
                <!-- ç”¨æˆ·åå¯†ç ç™»å½•æŒ‰é’® -->
                <button id="usernamePasswordLoginBtn" class="w-full bg-gradient-to-r from-bonk-orange to-bonk-dark text-white rounded-xl py-4 px-6 font-medium transition-all duration-300 hover:shadow-lg hover:shadow-bonk-orange/25 flex items-center justify-center space-x-3 group">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center group-hover:bg-white/30 transition-colors">
                        <i class="fa fa-user text-white"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-semibold">ç”¨æˆ·åå¯†ç ç™»å½•</div>
                        <div class="text-sm opacity-90">å·²æœ‰è´¦å·ï¼Ÿç›´æ¥ç™»å½•</div>
                    </div>
                    <i class="fa fa-arrow-right ml-auto opacity-60 group-hover:opacity-100 transition-opacity"></i>
                </button>
                
                <!-- åŒ¿åç™»å½•æŒ‰é’® -->
                <button id="anonymousLoginBtn" class="w-full bg-transparent border-2 border-bonk-orange text-bonk-orange rounded-xl py-4 px-6 font-medium transition-all duration-300 hover:bg-bonk-orange hover:text-white flex items-center justify-center space-x-3 group">
                    <div class="w-10 h-10 bg-bonk-orange/20 rounded-full flex items-center justify-center group-hover:bg-white/20 transition-colors">
                        <i class="fa fa-user-secret text-bonk-orange group-hover:text-white"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-semibold">åŒ¿åç™»å½•</div>
                        <div class="text-sm opacity-90">è®¾ç½®ç”¨æˆ·åå’Œå¤´åƒ</div>
                    </div>
                    <i class="fa fa-arrow-right ml-auto opacity-60 group-hover:opacity-100 transition-opacity"></i>
                </button>
                
                <!-- é’±åŒ…ç™»å½•æŒ‰é’® -->
                <button id="walletLoginBtn" class="w-full bg-transparent border-2 border-solana-blue text-solana-blue rounded-xl py-4 px-6 font-medium transition-all duration-300 hover:bg-solana-blue hover:text-white flex items-center justify-center space-x-3 group">
                    <div class="w-10 h-10 bg-solana-blue/20 rounded-full flex items-center justify-center group-hover:bg-white/20 transition-colors">
                        <i class="fa fa-wallet text-solana-blue group-hover:text-white"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-semibold">é’±åŒ…ç™»å½•</div>
                        <div class="text-sm opacity-90">è¿æ¥Solanaé’±åŒ…</div>
                    </div>
                    <i class="fa fa-arrow-right ml-auto opacity-60 group-hover:opacity-100 transition-opacity"></i>
                </button>
            </div>
            
            <!-- åº•éƒ¨è¯´æ˜ -->
            <div class="mt-8 text-center">
                <p class="text-xs text-gray-500">
                    ç™»å½•å³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘ä»¬çš„
                    <a href="#" class="text-bonk-orange hover:text-bonk-light">æœåŠ¡æ¡æ¬¾</a>
                    å’Œ
                    <a href="#" class="text-bonk-orange hover:text-bonk-light">éšç§æ”¿ç­–</a>
                </p>
            </div>
        </div>
    </div>

    <!-- é’±åŒ…é€‰æ‹©å¼¹çª— -->
    <div id="walletSelectModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-chat-bg rounded-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="walletSelectModalContent">
            <!-- å…³é—­æŒ‰é’® -->
            <button id="closeWalletSelectModal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                <i class="fa fa-times text-xl"></i>
            </button>
            
            <!-- å¼¹çª—å¤´éƒ¨ -->
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-r from-solana-blue to-solana-dark rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-wallet text-white text-2xl"></i>
                </div>
                <h2 class="text-xl font-bold text-white mb-2">é€‰æ‹©é’±åŒ…</h2>
                <p class="text-gray-400">é€‰æ‹©æ‚¨è¦è¿æ¥çš„Solanaé’±åŒ…</p>
            </div>
            
            <!-- é’±åŒ…é€‰é¡¹ -->
            <div class="space-y-3">
                <!-- Phantomé’±åŒ… -->
                <button id="phantomWalletBtn" class="w-full bg-gray-800 hover:bg-gray-700 text-white rounded-xl py-4 px-6 font-medium transition-all duration-300 flex items-center justify-center space-x-3 group">
                    <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center">
                        <i class="fa fa-ghost text-white"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-semibold">Phantom</div>
                        <div class="text-sm opacity-90">å¹½çµé’±åŒ…</div>
                    </div>
                    <i class="fa fa-arrow-right ml-auto opacity-60 group-hover:opacity-100 transition-opacity"></i>
                </button>
                
                <!-- OKXé’±åŒ… -->
                <button id="okxWalletBtn" class="w-full bg-gray-800 hover:bg-gray-700 text-white rounded-xl py-4 px-6 font-medium transition-all duration-300 flex items-center justify-center space-x-3 group">
                    <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
                        <i class="fa fa-exchange text-white"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-semibold">OKX</div>
                        <div class="text-sm opacity-90">OKXé’±åŒ…</div>
                    </div>
                    <i class="fa fa-arrow-right ml-auto opacity-60 group-hover:opacity-100 transition-opacity"></i>
                </button>
                
                <!-- Solflareé’±åŒ… -->
                <button id="solflareWalletBtn" class="w-full bg-gray-800 hover:bg-gray-700 text-white rounded-xl py-4 px-6 font-medium transition-all duration-300 flex items-center justify-center space-x-3 group">
                    <div class="w-10 h-10 bg-orange-600 rounded-full flex items-center justify-center">
                        <i class="fa fa-sun-o text-white"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-semibold">Solflare</div>
                        <div class="text-sm opacity-90">Solflareé’±åŒ…</div>
                    </div>
                    <i class="fa fa-arrow-right ml-auto opacity-60 group-hover:opacity-100 transition-opacity"></i>
                </button>
            </div>
            
            <!-- åº•éƒ¨è¯´æ˜ -->
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-500">
                    æ²¡æœ‰é’±åŒ…ï¼Ÿ<a href="https://phantom.app/" target="_blank" class="text-bonk-orange hover:text-bonk-light">ä¸‹è½½Phantom</a>
                </p>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·æ³¨å†Œå¼¹çª— -->
    <div id="userRegisterModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-chat-bg rounded-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="userRegisterModalContent">
            <!-- å…³é—­æŒ‰é’® -->
            <button id="closeUserRegisterModal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                <i class="fa fa-times text-xl"></i>
            </button>
            
            <!-- å¼¹çª—å¤´éƒ¨ -->
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-bonk-orange to-bonk-dark rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-user-plus text-white text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">åˆ›å»ºæ‚¨çš„è´¦æˆ·</h2>
                <p class="text-gray-400">è®¾ç½®ç”¨æˆ·åå’Œå¤´åƒå¼€å§‹èŠå¤©</p>
            </div>
            
            <!-- æ³¨å†Œè¡¨å• -->
            <form id="userRegisterForm" class="space-y-6">
                <!-- å¤´åƒä¸Šä¼  -->
                <div class="text-center">
                    <div class="relative inline-block">
                        <div id="avatarPreview" class="w-24 h-24 bg-gray-700 rounded-full mx-auto mb-4 flex items-center justify-center cursor-pointer hover:bg-gray-600 transition-colors">
                            <i class="fa fa-camera text-gray-400 text-2xl"></i>
                        </div>
                        <input type="file" id="avatarInput" accept="image/*" class="hidden">
                        <div id="avatarLoading" class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center hidden">
                            <div class="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400">ç‚¹å‡»ä¸Šä¼ å¤´åƒ</p>
                </div>
                
                <!-- ç”¨æˆ·åè¾“å…¥ -->
                <div>
                    <label for="usernameInput" class="block text-sm font-medium text-gray-300 mb-2">ç”¨æˆ·å</label>
                    <div class="relative">
                        <input type="text" id="usernameInput" 
                            class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-bonk-orange focus:border-transparent"
                            placeholder="è¾“å…¥ç”¨æˆ·åï¼ˆ2-20ä¸ªå­—ç¬¦ï¼‰" 
                            minlength="2" 
                            maxlength="20" 
                            required>
                        <div id="usernameStatus" class="absolute right-3 top-1/2 transform -translate-y-1/2 hidden">
                            <i class="fa fa-check text-green-500"></i>
                        </div>
                    </div>
                    <p id="usernameError" class="text-red-500 text-xs mt-1 hidden">ç”¨æˆ·åå·²è¢«ä½¿ç”¨</p>
                    <p id="usernameHint" class="text-gray-400 text-xs mt-1">ç”¨æˆ·åå°†æ˜¾ç¤ºåœ¨èŠå¤©ä¸­</p>
                </div>
                
                <!-- å¯†ç è¾“å…¥ -->
                <div>
                    <label for="passwordInput" class="block text-sm font-medium text-gray-300 mb-2">å¯†ç </label>
                    <div class="relative">
                        <input type="password" id="passwordInput" 
                            class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-bonk-orange focus:border-transparent"
                            placeholder="è®¾ç½®å¯†ç ï¼ˆ6-20ä¸ªå­—ç¬¦ï¼‰" 
                            minlength="6" 
                            maxlength="20" 
                            required>
                        <button type="button" id="togglePassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white">
                            <i class="fa fa-eye"></i>
                        </button>
                    </div>
                    <p id="passwordHint" class="text-gray-400 text-xs mt-1">å¯†ç ç”¨äºä¸‹æ¬¡ç™»å½•</p>
                </div>
                
                <!-- ç¡®è®¤å¯†ç è¾“å…¥ -->
                <div>
                    <label for="confirmPasswordInput" class="block text-sm font-medium text-gray-300 mb-2">ç¡®è®¤å¯†ç </label>
                    <div class="relative">
                        <input type="password" id="confirmPasswordInput" 
                            class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-bonk-orange focus:border-transparent"
                            placeholder="å†æ¬¡è¾“å…¥å¯†ç " 
                            required>
                        <button type="button" id="toggleConfirmPassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white">
                            <i class="fa fa-eye"></i>
                        </button>
                    </div>
                    <p id="confirmPasswordError" class="text-red-500 text-xs mt-1 hidden">ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´</p>
                </div>
                
                <!-- ç”¨æˆ·æ ‡ç­¾é€‰æ‹© -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">é€‰æ‹©æ ‡ç­¾</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" class="badge-btn bg-gray-800 hover:bg-gray-700 text-white rounded-lg px-3 py-2 text-sm transition-colors" data-badge="Bonkçˆ±å¥½è€…">
                            Bonkçˆ±å¥½è€…
                        </button>
                        <button type="button" class="badge-btn bg-gray-800 hover:bg-gray-700 text-white rounded-lg px-3 py-2 text-sm transition-colors" data-badge="æŒæœ‰NFT">
                            æŒæœ‰NFT
                        </button>
                        <button type="button" class="badge-btn bg-gray-800 hover:bg-gray-700 text-white rounded-lg px-3 py-2 text-sm transition-colors" data-badge="Bonkå¤§ä½¬">
                            Bonkå¤§ä½¬
                        </button>
                        <button type="button" class="badge-btn bg-gray-800 hover:bg-gray-700 text-white rounded-lg px-3 py-2 text-sm transition-colors" data-badge="Solanaç²‰ä¸">
                            Solanaç²‰ä¸
                        </button>
                    </div>
                </div>
                
                <!-- æ³¨å†ŒæŒ‰é’® -->
                <button type="submit" id="registerBtn" class="w-full bg-gradient-to-r from-bonk-orange to-bonk-dark text-white rounded-xl py-4 px-6 font-medium transition-all duration-300 hover:shadow-lg hover:shadow-bonk-orange/25 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="registerBtnText">åˆ›å»ºè´¦æˆ·</span>
                    <div id="registerBtnLoading" class="hidden">
                        <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mx-auto"></div>
                    </div>
                </button>
            </form>
        </div>
    </div>

    <!-- ç”¨æˆ·åå¯†ç ç™»å½•å¼¹çª— -->
    <div id="usernamePasswordLoginModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-chat-bg rounded-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="usernamePasswordLoginModalContent">
            <!-- å…³é—­æŒ‰é’® -->
            <button id="closeUsernamePasswordLoginModal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                <i class="fa fa-times text-xl"></i>
            </button>
            
            <!-- å¼¹çª—å¤´éƒ¨ -->
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-bonk-orange to-bonk-dark rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-sign-in text-white text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">ç”¨æˆ·åå¯†ç ç™»å½•</h2>
                <p class="text-gray-400">è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ç™»å½•</p>
            </div>
            
            <!-- ç™»å½•è¡¨å• -->
            <form id="usernamePasswordLoginForm" class="space-y-6">
                <!-- ç”¨æˆ·åè¾“å…¥ -->
                <div>
                    <label for="loginUsernameInput" class="block text-sm font-medium text-gray-300 mb-2">ç”¨æˆ·å</label>
                    <input type="text" id="loginUsernameInput" 
                        class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-bonk-orange focus:border-transparent"
                        placeholder="è¾“å…¥ç”¨æˆ·å" 
                        required>
                </div>
                
                <!-- å¯†ç è¾“å…¥ -->
                <div>
                    <label for="loginPasswordInput" class="block text-sm font-medium text-gray-300 mb-2">å¯†ç </label>
                    <div class="relative">
                        <input type="password" id="loginPasswordInput" 
                            class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-bonk-orange focus:border-transparent"
                            placeholder="è¾“å…¥å¯†ç " 
                            required>
                        <button type="button" id="toggleLoginPassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white">
                            <i class="fa fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <!-- ç™»å½•æŒ‰é’® -->
                <button type="submit" id="usernamePasswordLoginBtn" class="w-full bg-gradient-to-r from-bonk-orange to-bonk-dark text-white rounded-xl py-4 px-6 font-medium transition-all duration-300 hover:shadow-lg hover:shadow-bonk-orange/25 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="usernamePasswordLoginBtnText">ç™»å½•</span>
                    <div id="usernamePasswordLoginBtnLoading" class="hidden">
                        <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mx-auto"></div>
                    </div>
                </button>
                
                <!-- åº•éƒ¨é“¾æ¥ -->
                <div class="text-center">
                    <p class="text-xs text-gray-500">
                        è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ
                        <button type="button" id="switchToRegister" class="text-bonk-orange hover:text-bonk-light">ç«‹å³æ³¨å†Œ</button>
                    </p>
                </div>
            </form>
        </div>
    </div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loadingIndicator" class="fixed inset-0 bg-chat-bg bg-opacity-75 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-bonk-orange border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-white text-lg">æ­£åœ¨è¿æ¥BonkèŠå¤©...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script>
        // ç­‰å¾…Firebaseåˆå§‹åŒ–å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            // ç­‰å¾…Firebaseæ¨¡å—åŠ è½½
            const checkFirebase = setInterval(() => {
                if (window.firebase) {
                    clearInterval(checkFirebase);
                    initializeApp();
                }
            }, 100);
        });

        function initializeApp() {
        // DOMå…ƒç´ 
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const communityPanel = document.getElementById('communityPanel');
        const connectWalletBtn = document.getElementById('connectWallet');
        const walletConnected = document.getElementById('walletConnected');
        const walletToast = document.getElementById('walletToast');
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPanel = document.getElementById('emojiPanel');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messageArea = document.getElementById('messageArea');
        const emojiButtons = document.querySelectorAll('.emoji-btn');
            const imageUploadBtn = document.getElementById('imageUploadBtn');
            const imageInput = document.getElementById('imageInput');
            const loginBtn = document.getElementById('loginBtn');
            const loginModal = document.getElementById('loginModal');
            const loginModalContent = document.getElementById('loginModalContent');
            const closeLoginModal = document.getElementById('closeLoginModal');
            const anonymousLoginBtn = document.getElementById('anonymousLoginBtn');
            const walletLoginBtn = document.getElementById('walletLoginBtn');
            const userProfile = document.getElementById('userProfile');
            const logoutBtn = document.getElementById('logoutBtn');
            const userName = document.getElementById('userName');
            const userStatus = document.getElementById('userStatus');
            const walletSelectModal = document.getElementById('walletSelectModal');
            const walletSelectModalContent = document.getElementById('walletSelectModalContent');
            const closeWalletSelectModal = document.getElementById('closeWalletSelectModal');
            const phantomWalletBtn = document.getElementById('phantomWalletBtn');
            const okxWalletBtn = document.getElementById('okxWalletBtn');
            const solflareWalletBtn = document.getElementById('solflareWalletBtn');
            const disconnectWalletBtn = document.getElementById('disconnectWalletBtn');
            const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
            const userRegisterModal = document.getElementById('userRegisterModal');
            const userRegisterModalContent = document.getElementById('userRegisterModalContent');
            const closeUserRegisterModal = document.getElementById('closeUserRegisterModal');
            const userRegisterForm = document.getElementById('userRegisterForm');
            const avatarPreview = document.getElementById('avatarPreview');
            const avatarInput = document.getElementById('avatarInput');
            const avatarLoading = document.getElementById('avatarLoading');
            const usernameInput = document.getElementById('usernameInput');
            const usernameStatus = document.getElementById('usernameStatus');
            const usernameError = document.getElementById('usernameError');
            const usernameHint = document.getElementById('usernameHint');
            const registerBtn = document.getElementById('registerBtn');
            const registerBtnText = document.getElementById('registerBtnText');
            const registerBtnLoading = document.getElementById('registerBtnLoading');
            const badgeButtons = document.querySelectorAll('.badge-btn');
            const userAvatarContainer = document.getElementById('userAvatarContainer');
            const userAvatarIcon = document.getElementById('userAvatarIcon');
            const memberList = document.getElementById('memberList');
            const usernamePasswordLoginBtn = document.getElementById('usernamePasswordLoginBtn');
            const usernamePasswordLoginModal = document.getElementById('usernamePasswordLoginModal');
            const usernamePasswordLoginModalContent = document.getElementById('usernamePasswordLoginModalContent');
            const closeUsernamePasswordLoginModal = document.getElementById('closeUsernamePasswordLoginModal');
            const usernamePasswordLoginForm = document.getElementById('usernamePasswordLoginForm');
            const loginUsernameInput = document.getElementById('loginUsernameInput');
            const loginPasswordInput = document.getElementById('loginPasswordInput');
            const toggleLoginPassword = document.getElementById('toggleLoginPassword');
            const usernamePasswordLoginBtnText = document.getElementById('usernamePasswordLoginBtnText');
            const usernamePasswordLoginBtnLoading = document.getElementById('usernamePasswordLoginBtnLoading');
            const switchToRegister = document.getElementById('switchToRegister');
            const passwordInput = document.getElementById('passwordInput');
            const confirmPasswordInput = document.getElementById('confirmPasswordInput');
            const togglePassword = document.getElementById('togglePassword');
            const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
            const confirmPasswordError = document.getElementById('confirmPasswordError');

            // Firebaseå®ä¾‹
            const { auth, database, storage, ref, push, onValue, off, set, get, child, signInAnonymously, onAuthStateChanged } = window.firebase;

            // å…¨å±€å˜é‡
            let currentUser = null;
            let messagesRef = null;
            let userStatusRef = null;
            let isTyping = false;
            let typingTimeout = null;
            let shouldAutoScroll = true; // æ˜¯å¦åº”è¯¥è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨

            // ç”¨æˆ·æ•°æ®
            const userProfiles = {
                'default': {
                    name: 'Bonkç”¨æˆ·',
                    avatar: 'https://picsum.photos/id/1012/200',
                    badge: 'Bonkçˆ±å¥½è€…',
                    bonkAmount: '1k+ Bonk'
                }
            };

            // ç®€å•çš„å¯†ç å“ˆå¸Œå‡½æ•°ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹æ³•ï¼‰
            async function hashPassword(password) {
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }

            // å¯†ç æ˜¾ç¤º/éšè—åˆ‡æ¢
            function setupPasswordToggles() {
                // æ³¨å†Œé¡µé¢çš„å¯†ç æ˜¾ç¤º/éšè—
                togglePassword.addEventListener('click', () => {
                    const type = passwordInput.type === 'password' ? 'text' : 'password';
                    passwordInput.type = type;
                    togglePassword.innerHTML = type === 'password' ? '<i class="fa fa-eye"></i>' : '<i class="fa fa-eye-slash"></i>';
                });

                toggleConfirmPassword.addEventListener('click', () => {
                    const type = confirmPasswordInput.type === 'password' ? 'text' : 'password';
                    confirmPasswordInput.type = type;
                    toggleConfirmPassword.innerHTML = type === 'password' ? '<i class="fa fa-eye"></i>' : '<i class="fa fa-eye-slash"></i>';
                });

                // ç™»å½•é¡µé¢çš„å¯†ç æ˜¾ç¤º/éšè—
                toggleLoginPassword.addEventListener('click', () => {
                    const type = loginPasswordInput.type === 'password' ? 'text' : 'password';
                    loginPasswordInput.type = type;
                    toggleLoginPassword.innerHTML = type === 'password' ? '<i class="fa fa-eye"></i>' : '<i class="fa fa-eye-slash"></i>';
                });
            }

            // å¯†ç éªŒè¯
            function validatePasswords() {
                const password = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                
                if (password !== confirmPassword) {
                    confirmPasswordError.classList.remove('hidden');
                    return false;
                } else {
                    confirmPasswordError.classList.add('hidden');
                    return true;
                }
            }

            // ç›‘å¬å¯†ç è¾“å…¥å˜åŒ–
            confirmPasswordInput.addEventListener('input', validatePasswords);
            passwordInput.addEventListener('input', validatePasswords);

            // åˆå§‹åŒ–è®¤è¯
            function initializeAuth() {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        console.log('ç”¨æˆ·å·²ç™»å½•:', user.uid);
                        loadUserProfile(user.uid);
                        initializeChat();
                        updateUserStatus('online');
                        hideLoadingIndicator();
                    } else {
                        // æ£€æŸ¥æ˜¯å¦æœ‰é’±åŒ…è¿æ¥
                        const walletAddress = window.getSolanaWalletAddress();
                        if (walletAddress) {
                            // é’±åŒ…å·²è¿æ¥ï¼Œå°è¯•åŠ è½½é’±åŒ…ç”¨æˆ·èµ„æ–™
                            const walletUserId = `wallet_${walletAddress}`;
                            loadUserProfile(walletUserId);
                        } else {
                            // æœªç™»å½•ä¹Ÿåˆå§‹åŒ–èŠå¤©ï¼ˆåªè¯»ï¼‰
                            currentUser = null;
                            initializeChat();
                            hideLoadingIndicator();
                            updateLoginUI(false);
                        }
                    }
                });
            }

            // åŠ è½½ç”¨æˆ·èµ„æ–™
            async function loadUserProfile(userId) {
                try {
                    const userProfileRef = ref(database, `userProfiles/${userId}`);
                    const snapshot = await get(userProfileRef);
                    
                    if (snapshot.exists()) {
                        const profile = snapshot.val();
                        userProfiles[userId] = {
                            name: profile.username,
                            avatar: profile.avatar,
                            badge: profile.badge
                        };
                        console.log('ç”¨æˆ·èµ„æ–™åŠ è½½æˆåŠŸ:', profile);
                        
                        // è®¾ç½®å½“å‰ç”¨æˆ·
                        currentUser = { uid: userId };
                        
                        // æ›´æ–°UIæ˜¾ç¤º
                        updateLoginUI(true);
                        
                        // æ›´æ–°ç”¨æˆ·çŠ¶æ€ä¸ºåœ¨çº¿
                        updateUserStatus('online');
                        
                        // åˆå§‹åŒ–èŠå¤©
                        initializeChat();
                        hideLoadingIndicator();
                    } else {
                        console.log('ç”¨æˆ·èµ„æ–™ä¸å­˜åœ¨ï¼Œéœ€è¦æ³¨å†Œ');
                        // å¦‚æœæ˜¯é’±åŒ…ç”¨æˆ·ä½†èµ„æ–™ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºæ³¨å†Œå¼¹çª—
                        if (userId.startsWith('wallet_')) {
                            showUserRegisterModal();
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                }
            }

            // æ›´æ–°ç™»å½•UIçŠ¶æ€
            function updateLoginUI(isLoggedIn) {
                if (isLoggedIn) {
                    loginBtn.classList.add('hidden');
                    userProfile.classList.remove('hidden');
                    // èŠå¤©è¾“å…¥åŒºå¯ç”¨
                    messageInput.disabled = false;
                    sendBtn.disabled = false;
                    sendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    imageUploadBtn.disabled = false;
                    emojiBtn.disabled = false;
                    messageInput.placeholder = 'è¯´ç‚¹Bonkç›¸å…³çš„...';
                    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                    const userProfileData = userProfiles[currentUser.uid];
                    if (userProfileData) {
                        userName.textContent = userProfileData.name;
                        userStatus.textContent = userProfileData.badge || 'åœ¨çº¿';
                        
                        // æ›´æ–°å¤´åƒ
                        if (userProfileData.avatar) {
                            // éšè—é»˜è®¤å›¾æ ‡
                            userAvatarIcon.classList.add('hidden');
                            // è®¾ç½®å¤´åƒå›¾ç‰‡
                            userAvatarContainer.innerHTML = `<img src="${userProfileData.avatar}" alt="ç”¨æˆ·å¤´åƒ" class="w-full h-full rounded-full object-cover">`;
                        } else {
                            // æ˜¾ç¤ºé»˜è®¤å›¾æ ‡
                            userAvatarIcon.classList.remove('hidden');
                            userAvatarContainer.innerHTML = `<i class="fa fa-user text-chat-text-dark font-bold" id="userAvatarIcon"></i>`;
                        }
                    } else {
                        userName.textContent = 'Bonkç”¨æˆ·';
                        userStatus.textContent = 'åœ¨çº¿';
                        // æ˜¾ç¤ºé»˜è®¤å›¾æ ‡
                        userAvatarIcon.classList.remove('hidden');
                        userAvatarContainer.innerHTML = `<i class="fa fa-user text-chat-text-dark font-bold" id="userAvatarIcon"></i>`;
                    }
                } else {
                    loginBtn.classList.remove('hidden');
                    userProfile.classList.add('hidden');
                    // èŠå¤©è¾“å…¥åŒºç¦ç”¨
                    messageInput.disabled = true;
                    sendBtn.disabled = true;
                    sendBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    imageUploadBtn.disabled = true;
                    emojiBtn.disabled = true;
                    messageInput.placeholder = 'è¯·å…ˆç™»å½•åæ‰èƒ½å‘è¨€';
                }
            }

            // éšè—åŠ è½½æŒ‡ç¤ºå™¨
            function hideLoadingIndicator() {
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.opacity = '0';
                    setTimeout(() => {
                        loadingIndicator.style.display = 'none';
                    }, 300);
                }
            }

                        // åˆå§‹åŒ–èŠå¤©åŠŸèƒ½
            function initializeChat() {
                messagesRef = ref(database, 'messages');
                userStatusRef = ref(database, 'userStatus');
                
                // ç›‘å¬æ¶ˆæ¯
                onValue(messagesRef, (snapshot) => {
                    const messages = [];
                    snapshot.forEach((childSnapshot) => {
                        messages.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    
                    // æŒ‰æ—¶é—´æ’åº
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    displayMessages(messages);
                });

                // ç›‘å¬ç”¨æˆ·çŠ¶æ€
                onValue(userStatusRef, (snapshot) => {
                    updateOnlineUsers(snapshot.val());
                    // æ›´æ–°åœ¨çº¿ç”¨æˆ·æ•°é‡
                    if (snapshot.exists()) {
                        const users = snapshot.val();
                        const onlineCount = Object.values(users).filter(user => user.status === 'online').length;
                        updateOnlineCount(onlineCount);
                    }
                });

                // ç›‘å¬è¾“å…¥çŠ¶æ€
                const typingRef = ref(database, 'typing');
                onValue(typingRef, (snapshot) => {
                    updateTypingIndicator(snapshot.val());
                });
                
                // åˆå§‹åŒ–ç¾¤æˆå‘˜åˆ—è¡¨
                initializeMemberList();
            }

            // æ˜¾ç¤ºæ¶ˆæ¯
            function displayMessages(messages) {
                // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸï¼ˆä¿ç•™ç³»ç»Ÿæ¶ˆæ¯ï¼‰
                const systemMessages = messageArea.querySelectorAll('.flex.justify-center');
                messageArea.innerHTML = '';
                systemMessages.forEach(msg => messageArea.appendChild(msg));

                messages.forEach(message => {
                    const messageElement = createMessageElement(message);
                    messageArea.appendChild(messageElement);
                });

                // åªåœ¨åº”è¯¥è‡ªåŠ¨æ»šåŠ¨æ—¶æ‰æ»šåŠ¨åˆ°åº•éƒ¨
                if (shouldAutoScroll) {
                    setTimeout(() => {
                        messageArea.scrollTo({
                            top: messageArea.scrollHeight,
                            behavior: 'smooth'
                        });
                    }, 100);
                }
            }

            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            function createMessageElement(message) {
                const isOwnMessage = currentUser && message.userId === currentUser.uid;
                const timeString = new Date(message.timestamp).toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const messageDiv = document.createElement('div');
                messageDiv.className = `flex items-start space-x-3 message-appear ${isOwnMessage ? 'justify-end' : ''}`;

                // å¤´åƒéƒ¨åˆ†
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'relative';
                const avatarImg = document.createElement('img');
                avatarImg.src = message.userAvatar || (isOwnMessage ? 'https://picsum.photos/id/1012/200' : 'https://picsum.photos/id/237/200');
                avatarImg.alt = isOwnMessage ? 'è‡ªå·±çš„å¤´åƒ' : 'ç”¨æˆ·å¤´åƒ';
                avatarImg.className = `w-10 h-10 rounded-full object-cover border-2 ${isOwnMessage ? 'border-bonk-orange' : 'border-gray-700'}`;
                avatarDiv.appendChild(avatarImg);
                const statusDot = document.createElement('div');
                statusDot.className = 'absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-chat-bg';
                avatarDiv.appendChild(statusDot);

                // å†…å®¹éƒ¨åˆ†
                const contentDiv = document.createElement('div');
                contentDiv.className = 'max-w-[80%]';

                // é¡¶éƒ¨ä¿¡æ¯
                const infoDiv = document.createElement('div');
                infoDiv.className = `flex items-center ${isOwnMessage ? 'justify-end' : ''} space-x-2 mb-1`;
                if (isOwnMessage) {
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'text-gray-400 text-xs';
                    timeSpan.textContent = timeString;
                    infoDiv.appendChild(timeSpan);
                    const badgeSpan = document.createElement('span');
                    badgeSpan.className = 'bg-bonk-orange/20 text-bonk-orange text-xs px-2 py-0.5 rounded-full';
                    badgeSpan.textContent = message.userBadge || 'Bonkå¤§ä½¬';
                    infoDiv.appendChild(badgeSpan);
                } else {
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'font-semibold text-sm';
                    nameSpan.textContent = message.userName || 'Bonkç”¨æˆ·';
                    infoDiv.appendChild(nameSpan);
                    const badgeSpan = document.createElement('span');
                    badgeSpan.className = 'bg-solana-blue/20 text-solana-blue text-xs px-2 py-0.5 rounded-full';
                    badgeSpan.textContent = message.userBadge || 'Bonkçˆ±å¥½è€…';
                    infoDiv.appendChild(badgeSpan);
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'text-gray-400 text-xs';
                    timeSpan.textContent = timeString;
                    infoDiv.appendChild(timeSpan);
                }
                contentDiv.appendChild(infoDiv);

                // æ¶ˆæ¯å†…å®¹
                if (message.type === 'image') {
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'rounded-xl overflow-hidden border border-gray-700 max-w-xs';
                    const img = document.createElement('img');
                    img.src = message.imageUrl;
                    img.alt = 'èŠå¤©å›¾ç‰‡';
                    img.className = 'w-full h-auto cursor-pointer hover:opacity-90 transition-opacity';
                    img.onclick = () => openImageModal(message.imageUrl);
                    imageContainer.appendChild(img);
                    contentDiv.appendChild(imageContainer);
                } else {
                    const textContainer = document.createElement('div');
                    textContainer.className = `bg-${isOwnMessage ? 'gradient-to-r from-bonk-orange to-bonk-dark text-white' : 'chat-bubble text-chat-textDark'} rounded-2xl ${isOwnMessage ? 'rounded-tr-none' : 'rounded-tl-none'} px-4 py-2.5 text-sm`;
                    textContainer.innerHTML = formatMessageText(message.text);
                    contentDiv.appendChild(textContainer);
                }

                // ç»„è£…
                if (isOwnMessage) {
                    messageDiv.appendChild(contentDiv);
                    messageDiv.appendChild(avatarDiv);
                } else {
                    messageDiv.appendChild(avatarDiv);
                    messageDiv.appendChild(contentDiv);
                }
                return messageDiv;
            }

            // æ ¼å¼åŒ–æ¶ˆæ¯æ–‡æœ¬
            function formatMessageText(text) {
                if (typeof text !== 'string') return '';
                
                // å®‰å…¨è½¬ä¹‰HTMLï¼Œç„¶åè¿›è¡Œå®‰å…¨çš„æ ¼å¼åŒ–
                const escapedText = sanitizeHTML(text);
                return escapedText
                    .replace(/Bonk!/g, 'Bonk! ğŸ¶')
                    .replace(/æš´æ¶¨|æ‹‰ç›˜/g, match => `<span class="bonk-highlight">${match}</span>`)
                    .replace(/\n/g, '<br>');
            }

            // å‘é€æ¶ˆæ¯
            function sendMessage() {
                const messageText = validateInput(messageInput.value.trim(), 1000);
                if (!messageText) return;
                
                if (!currentUser) {
                    showToast('è¯·å…ˆç™»å½•åå†å‘é€æ¶ˆæ¯', 'warning');
                    showLoginModal();
                    return;
                }

                const userProfileData = userProfiles[currentUser.uid];
                const messageData = {
                    text: messageText,
                    userId: currentUser.uid,
                    userName: userProfileData?.name || 'Bonkç”¨æˆ·',
                    userAvatar: userProfileData?.avatar || 'https://picsum.photos/id/1012/200',
                    userBadge: userProfileData?.badge || 'Bonkçˆ±å¥½è€…',
                    timestamp: Date.now()
                };
                
                // å¦‚æœæ˜¯é’±åŒ…ç”¨æˆ·ï¼Œæ·»åŠ é’±åŒ…åœ°å€ä¿¡æ¯
                if (currentUser.uid.startsWith('wallet_')) {
                    messageData.walletAddress = currentUser.uid.replace('wallet_', '');
                }

                // æ¨é€åˆ°Firebase
                push(messagesRef, messageData)
                    .then(() => {
                        messageInput.value = '';
                        messageInput.style.height = 'auto';
                        updateTypingStatus(false);
                        // å‘é€æ¶ˆæ¯åæ€»æ˜¯æ»šåŠ¨åˆ°åº•éƒ¨
                        shouldAutoScroll = true;
                    })
                    .catch((error) => {
                        console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                        showToast('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    });
            }

            // æ›´æ–°ç”¨æˆ·çŠ¶æ€
            function updateUserStatus(status) {
                if (!currentUser) return;
                
                const userProfileData = userProfiles[currentUser.uid];
                const statusData = {
                    status: status,
                    lastSeen: Date.now(),
                    userName: userProfileData?.name || 'Bonkç”¨æˆ·',
                    userAvatar: userProfileData?.avatar || 'https://picsum.photos/id/1012/200'
                };
                
                // å¦‚æœæ˜¯é’±åŒ…ç”¨æˆ·ï¼Œæ·»åŠ é’±åŒ…åœ°å€ä¿¡æ¯
                if (currentUser.uid.startsWith('wallet_')) {
                    statusData.walletAddress = currentUser.uid.replace('wallet_', '');
                }
                
                set(ref(database, `userStatus/${currentUser.uid}`), statusData);
            }

            // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            function updateOnlineUsers(users) {
                if (!users) return;
                
                const onlineUsers = Object.entries(users)
                    .filter(([uid, user]) => user.status === 'online' && uid !== currentUser.uid)
                    .slice(0, 10);

                // è¿™é‡Œå¯ä»¥æ›´æ–°å³ä¾§ç”¨æˆ·åˆ—è¡¨
                console.log('åœ¨çº¿ç”¨æˆ·:', onlineUsers);
            }

            // æ›´æ–°è¾“å…¥çŠ¶æ€æŒ‡ç¤ºå™¨
            function updateTypingIndicator(typingUsers) {
                if (!typingUsers) return;
                
                const typingIndicator = messageArea.querySelector('.animate-pulse-slow');
                if (!typingIndicator) return;
                
                const typingUsersList = Object.entries(typingUsers)
                    .filter(([uid, user]) => uid !== currentUser.uid)
                    .filter(([uid, user]) => Date.now() - user.timestamp < 5000); // 5ç§’å†…çš„è¾“å…¥çŠ¶æ€

                if (typingUsersList.length > 0) {
                    const userNames = typingUsersList.map(([uid, user]) => validateInput(user.userName, 50)).join(', ');
                    // å®‰å…¨åˆ›å»ºè¾“å…¥æŒ‡ç¤ºå™¨
                    typingIndicator.innerHTML = '';
                    const span = document.createElement('span');
                    span.className = 'bg-bonk-orange/20 text-bonk-orange text-xs px-4 py-1 rounded-full animate-pulse-slow';
                    span.textContent = `${userNames} æ­£åœ¨è¾“å…¥...`;
                    typingIndicator.appendChild(span);
                    typingIndicator.parentElement.classList.remove('hidden');
                } else {
                    typingIndicator.parentElement.classList.add('hidden');
                }
            }

            // ä¸Šä¼ å›¾ç‰‡
            function uploadImage(file) {
                try {
                    validateImageFile(file);
                } catch (error) {
                    showToast(error.message, 'error');
                    return;
                }
                
                const storageRef = window.firebase.storageRef;
                const uploadBytes = window.firebase.uploadBytes;
                const getDownloadURL = window.firebase.getDownloadURL;
                
                // å®‰å…¨ç”Ÿæˆæ–‡ä»¶å
                const timestamp = Date.now();
                const safeFileName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                const imageRef = storageRef(storage, `chat-images/${timestamp}_${safeFileName}`);
                
                uploadBytes(imageRef, file)
                    .then((snapshot) => {
                        return getDownloadURL(snapshot.ref);
                    })
                    .then((downloadURL) => {
                        sendImageMessage(downloadURL);
                    })
                    .catch((error) => {
                        console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                        showToast('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    });
            }

            // å‘é€å›¾ç‰‡æ¶ˆæ¯
            function sendImageMessage(imageUrl) {
                if (!currentUser) return;

                const userProfileData = userProfiles[currentUser.uid];
                const messageData = {
                    type: 'image',
                    imageUrl: imageUrl,
                    userId: currentUser.uid,
                    userName: userProfileData?.name || 'Bonkç”¨æˆ·',
                    userAvatar: userProfileData?.avatar || 'https://picsum.photos/id/1012/200',
                    userBadge: userProfileData?.badge || 'Bonkçˆ±å¥½è€…',
                    timestamp: Date.now()
                };
                
                // å¦‚æœæ˜¯é’±åŒ…ç”¨æˆ·ï¼Œæ·»åŠ é’±åŒ…åœ°å€ä¿¡æ¯
                if (currentUser.uid.startsWith('wallet_')) {
                    messageData.walletAddress = currentUser.uid.replace('wallet_', '');
                }

                push(messagesRef, messageData)
                    .catch((error) => {
                        console.error('å‘é€å›¾ç‰‡æ¶ˆæ¯å¤±è´¥:', error);
                        showToast('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    });
            }

            // æ›´æ–°è¾“å…¥çŠ¶æ€
            function updateTypingStatus(typing) {
                if (!currentUser) return;
                
                const userProfileData = userProfiles[currentUser.uid];
                if (typing) {
                    isTyping = true;
                    const typingData = {
                        userName: userProfileData?.name || 'Bonkç”¨æˆ·',
                        timestamp: Date.now()
                    };
                    
                    // å¦‚æœæ˜¯é’±åŒ…ç”¨æˆ·ï¼Œæ·»åŠ é’±åŒ…åœ°å€ä¿¡æ¯
                    if (currentUser.uid.startsWith('wallet_')) {
                        typingData.walletAddress = currentUser.uid.replace('wallet_', '');
                    }
                    
                    set(ref(database, `typing/${currentUser.uid}`), typingData);
                } else {
                    isTyping = false;
                    set(ref(database, `typing/${currentUser.uid}`), null);
                }
            }

            // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
            function showToast(message, type = 'info') {
                // éªŒè¯è¾“å…¥
                const safeMessage = validateInput(message, 200);
                if (!safeMessage) return;
                
                let bgColor = 'blue';
                if (type === 'error') bgColor = 'red';
                else if (type === 'success') bgColor = 'green';
                else if (type === 'warning') bgColor = 'yellow';
                
                const toast = document.createElement('div');
                toast.className = `fixed top-4 right-4 bg-${bgColor}-500 text-white px-4 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full`;
                toast.textContent = safeMessage;
                document.body.appendChild(toast);
                
                // åŠ¨ç”»è¿›å…¥
                setTimeout(() => {
                    toast.classList.remove('translate-x-full');
                }, 100);
                
                setTimeout(() => {
                    toast.classList.add('translate-x-full');
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, 3000);
            }

            // æ·»åŠ æ¶ˆæ¯ååº”
            function addMessageReaction(messageId, reaction) {
                if (!currentUser) return;
                
                const reactionData = {
                    reaction: reaction,
                    timestamp: Date.now(),
                    userName: userProfiles[currentUser.uid]?.name || 'Bonkç”¨æˆ·'
                };
                
                // å¦‚æœæ˜¯é’±åŒ…ç”¨æˆ·ï¼Œæ·»åŠ é’±åŒ…åœ°å€ä¿¡æ¯
                if (currentUser.uid.startsWith('wallet_')) {
                    reactionData.walletAddress = currentUser.uid.replace('wallet_', '');
                }
                
                set(ref(database, `messages/${messageId}/reactions/${currentUser.uid}`), reactionData);
            }

            // è·å–åœ¨çº¿ç”¨æˆ·æ•°é‡
            function getOnlineUserCount() {
                if (!userStatusRef) return 0;
                
                get(userStatusRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const users = snapshot.val();
                        const onlineCount = Object.values(users).filter(user => user.status === 'online').length;
                        updateOnlineCount(onlineCount);
                    }
                });
            }

            // æ›´æ–°åœ¨çº¿ç”¨æˆ·æ•°é‡æ˜¾ç¤º
            function updateOnlineCount(count) {
                const onlineCountElements = document.querySelectorAll('.online-count');
                onlineCountElements.forEach(element => {
                    element.textContent = `${count}äººåœ¨çº¿`;
                });
            }

            // åˆå§‹åŒ–ç¾¤æˆå‘˜åˆ—è¡¨
            function initializeMemberList() {
                // ç›‘å¬æ‰€æœ‰ç”¨æˆ·èµ„æ–™
                const userProfilesRef = ref(database, 'userProfiles');
                onValue(userProfilesRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const profiles = snapshot.val();
                        displayMemberList(profiles);
                    } else {
                        displayMemberList({});
                    }
                });
                
                // ç›‘å¬ç”¨æˆ·çŠ¶æ€å˜åŒ–
                const userStatusRef = ref(database, 'userStatus');
                onValue(userStatusRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const userStatus = snapshot.val();
                        updateMemberStatus(userStatus);
                    }
                });
            }

            // æ˜¾ç¤ºç¾¤æˆå‘˜åˆ—è¡¨
            function displayMemberList(profiles) {
                if (!memberList) return;
                
                memberList.innerHTML = '';
                
                if (Object.keys(profiles).length === 0) {
                    memberList.innerHTML = `
                        <li class="text-center py-4">
                            <i class="fa fa-users text-gray-400 text-2xl mb-2"></i>
                            <p class="text-xs text-gray-400">æš‚æ— æˆå‘˜</p>
                        </li>
                    `;
                    return;
                }
                
                // å°†ç”¨æˆ·èµ„æ–™è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
                const members = Object.entries(profiles).map(([userId, profile]) => ({
                    userId,
                    ...profile
                })).sort((a, b) => {
                    // æŒ‰æœ€ååœ¨çº¿æ—¶é—´æ’åºï¼Œåœ¨çº¿ç”¨æˆ·ä¼˜å…ˆ
                    const aLastSeen = a.lastSeen || 0;
                    const bLastSeen = b.lastSeen || 0;
                    return bLastSeen - aLastSeen;
                });
                
                members.forEach(member => {
                    const memberElement = createMemberElement(member);
                    memberList.appendChild(memberElement);
                });
            }

            // åˆ›å»ºæˆå‘˜å…ƒç´ 
            function createMemberElement(member) {
                const li = document.createElement('li');
                li.className = 'member-item';
                li.dataset.userId = member.userId;
                
                const isCurrentUser = currentUser && member.userId === currentUser.uid;
                const borderClass = isCurrentUser ? 'border-bonk-orange' : 'border-gray-700';
                
                li.innerHTML = `
                    <a href="#" class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-800 transition-colors">
                        <div class="relative">
                            <img src="${member.avatar || 'https://picsum.photos/id/1012/200'}" 
                                alt="${member.username || 'ç”¨æˆ·'}çš„å¤´åƒ" 
                                class="w-10 h-10 rounded-full object-cover border-2 ${borderClass}"
                                onerror="this.src='https://picsum.photos/id/1012/200'">
                            <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-gray-500 rounded-full border-2 border-chat-bg member-status" data-user-id="${member.userId}"></div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium truncate">${member.username || 'Bonkç”¨æˆ·'}</p>
                            <p class="text-xs text-gray-400 truncate member-badge" data-user-id="${member.userId}">${member.badge || 'Bonkçˆ±å¥½è€…'}</p>
                        </div>
                    </a>
                `;
                
                return li;
            }

            // æ›´æ–°æˆå‘˜çŠ¶æ€
            function updateMemberStatus(userStatus) {
                if (!userStatus) return;
                
                // æ›´æ–°åœ¨çº¿çŠ¶æ€æŒ‡ç¤ºå™¨
                Object.entries(userStatus).forEach(([userId, status]) => {
                    const statusElement = document.querySelector(`.member-status[data-user-id="${userId}"]`);
                    if (statusElement) {
                        if (status.status === 'online') {
                            statusElement.className = 'absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-chat-bg member-status';
                            statusElement.dataset.userId = userId;
                        } else {
                            statusElement.className = 'absolute -bottom-1 -right-1 w-4 h-4 bg-gray-500 rounded-full border-2 border-chat-bg member-status';
                            statusElement.dataset.userId = userId;
                        }
                    }
                });
                
                // æ›´æ–°åœ¨çº¿ç”¨æˆ·æ•°é‡
                const onlineCount = Object.values(userStatus).filter(user => user.status === 'online').length;
                updateOnlineCount(onlineCount);
            }

            // äº‹ä»¶ç›‘å¬å™¨
        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('fixed');
            sidebar.classList.toggle('inset-0');
            sidebar.classList.toggle('w-full');
        });

            // ç™»å½•å¼¹çª—åŠŸèƒ½
            loginBtn.addEventListener('click', () => {
                showLoginModal();
            });

            closeLoginModal.addEventListener('click', () => {
                hideLoginModal();
            });

            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            loginModal.addEventListener('click', (e) => {
                if (e.target.id === 'loginModal') {
                    hideLoginModal();
                }
            });

            // åŒ¿åç™»å½•
            anonymousLoginBtn.addEventListener('click', () => {
                hideLoginModal();
                showUserRegisterModal();
            });

            // é’±åŒ…ç™»å½•
            walletLoginBtn.addEventListener('click', () => {
                hideLoginModal();
                showWalletSelectModal();
            });

            // ç”¨æˆ·åå¯†ç ç™»å½•
            usernamePasswordLoginBtn.addEventListener('click', () => {
                hideLoginModal();
                showUsernamePasswordLoginModal();
            });

            // ç”¨æˆ·åå¯†ç ç™»å½•å¼¹çª—åŠŸèƒ½
            closeUsernamePasswordLoginModal.addEventListener('click', () => {
                hideUsernamePasswordLoginModal();
            });

            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            usernamePasswordLoginModal.addEventListener('click', (e) => {
                if (e.target.id === 'usernamePasswordLoginModal') {
                    hideUsernamePasswordLoginModal();
                }
            });

            // æ˜¾ç¤ºç”¨æˆ·åå¯†ç ç™»å½•å¼¹çª—
            function showUsernamePasswordLoginModal() {
                usernamePasswordLoginModal.classList.remove('hidden');
                setTimeout(() => {
                    usernamePasswordLoginModalContent.classList.remove('scale-95', 'opacity-0');
                    usernamePasswordLoginModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            // éšè—ç”¨æˆ·åå¯†ç ç™»å½•å¼¹çª—
            function hideUsernamePasswordLoginModal() {
                usernamePasswordLoginModalContent.classList.remove('scale-100', 'opacity-100');
                usernamePasswordLoginModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    usernamePasswordLoginModal.classList.add('hidden');
                    // æ¸…ç©ºè¡¨å•
                    usernamePasswordLoginForm.reset();
                }, 300);
            }

            // åˆ‡æ¢åˆ°æ³¨å†Œ
            switchToRegister.addEventListener('click', () => {
                hideUsernamePasswordLoginModal();
                showUserRegisterModal();
            });

            // ç”¨æˆ·åå¯†ç ç™»å½•è¡¨å•æäº¤
            usernamePasswordLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const username = loginUsernameInput.value.trim();
                const password = loginPasswordInput.value;
                
                if (!username || !password) {
                    showToast('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                usernamePasswordLoginBtn.disabled = true;
                usernamePasswordLoginBtnText.classList.add('hidden');
                usernamePasswordLoginBtnLoading.classList.remove('hidden');
                
                try {
                    await performUsernamePasswordLogin(username, password);
                } catch (error) {
                    console.error('ç”¨æˆ·åå¯†ç ç™»å½•å¤±è´¥:', error);
                    showToast('ç™»å½•å¤±è´¥: ' + error.message, 'error');
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    usernamePasswordLoginBtn.disabled = false;
                    usernamePasswordLoginBtnText.classList.remove('hidden');
                    usernamePasswordLoginBtnLoading.classList.add('hidden');
                }
            });

            // æ‰§è¡Œç”¨æˆ·åå¯†ç ç™»å½•
            async function performUsernamePasswordLogin(username, password) {
                try {
                    // å…ˆæ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
                    const usernameRef = ref(database, `usernames/${username}`);
                    const usernameSnapshot = await get(usernameRef);
                    
                    if (!usernameSnapshot.exists()) {
                        throw new Error('ç”¨æˆ·åä¸å­˜åœ¨');
                    }
                    
                    const userId = usernameSnapshot.val().userId;
                    
                    // è·å–ç”¨æˆ·èµ„æ–™
                    const userProfileRef = ref(database, `userProfiles/${userId}`);
                    const profileSnapshot = await get(userProfileRef);
                    
                    if (!profileSnapshot.exists()) {
                        throw new Error('ç”¨æˆ·èµ„æ–™ä¸å­˜åœ¨');
                    }
                    
                    const profile = profileSnapshot.val();
                    
                    // éªŒè¯å¯†ç 
                    const hashedPassword = await hashPassword(password);
                    if (profile.passwordHash !== hashedPassword) {
                        throw new Error('å¯†ç é”™è¯¯');
                    }
                    
                    // ä½¿ç”¨åŒ¿åç™»å½•ï¼ˆå› ä¸ºFirebase Authä¸æ”¯æŒç”¨æˆ·åå¯†ç ç™»å½•ï¼‰
                    const authResult = await signInAnonymously(auth);
                    
                    // æ›´æ–°æœ¬åœ°ç”¨æˆ·èµ„æ–™
                    userProfiles[authResult.user.uid] = {
                        name: profile.username,
                        avatar: profile.avatar,
                        badge: profile.badge
                    };
                    
                    console.log('ç”¨æˆ·åå¯†ç ç™»å½•æˆåŠŸ:', authResult.user.uid);
                    hideUsernamePasswordLoginModal();
                    showToast('ç™»å½•æˆåŠŸï¼æ¬¢è¿å›æ¥', 'success');
                    
                    // ç«‹å³æ›´æ–°UIæ˜¾ç¤º
                    updateLoginUI(true);
                    
                    // æ›´æ–°ç”¨æˆ·çŠ¶æ€ä¸ºåœ¨çº¿
                    updateUserStatus('online');
                    
                } catch (error) {
                    throw error;
                }
            }

            // ç›‘å¬é’±åŒ…è¿æ¥äº‹ä»¶
            window.addEventListener('walletConnected', (e) => {
                connectWalletBtn.classList.add('hidden');
                walletConnected.classList.remove('hidden');
                
                const address = e.detail.address;
                const walletType = e.detail.walletType || 'Solana';
                const shortAddress = address.slice(0,6) + '...' + address.slice(-4);
                
                walletConnected.querySelector('p.text-sm').textContent = `${walletType}é’±åŒ…å·²è¿æ¥`;
                walletConnected.querySelector('p.text-xs').textContent = shortAddress;
                
                walletToast.classList.remove('hidden');
                setTimeout(() => { walletToast.classList.add('hidden'); }, 3000);
                
                // é’±åŒ…è¿æ¥æˆåŠŸåï¼Œè‡ªåŠ¨è¿›å…¥ç”¨æˆ·æ³¨å†Œæµç¨‹
                hideLoginModal();
                showUserRegisterModal();
            });

            // æ–­å¼€é’±åŒ…è¿æ¥
            disconnectWalletBtn.addEventListener('click', () => {
                window.disconnectSolanaWallet().then(() => {
                    connectWalletBtn.classList.remove('hidden');
                    walletConnected.classList.add('hidden');
                    showToast('é’±åŒ…å·²æ–­å¼€è¿æ¥', 'info');
                }).catch((error) => {
                    console.error('æ–­å¼€é’±åŒ…è¿æ¥å¤±è´¥:', error);
                    showToast('æ–­å¼€è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                });
            });

            // é€€å‡ºç™»å½•
            logoutBtn.addEventListener('click', () => {
                performLogout();
            });

            // æ˜¾ç¤ºç™»å½•å¼¹çª—
            function showLoginModal() {
                loginModal.classList.remove('hidden');
            setTimeout(() => {
                    loginModalContent.classList.remove('scale-95', 'opacity-0');
                    loginModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            // éšè—ç™»å½•å¼¹çª—
            function hideLoginModal() {
                loginModalContent.classList.remove('scale-100', 'opacity-100');
                loginModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    loginModal.classList.add('hidden');
                }, 300);
            }

            // æ‰§è¡ŒåŒ¿åç™»å½•
            function performAnonymousLogin() {
                anonymousLoginBtn.disabled = true;
                anonymousLoginBtn.innerHTML = `
                    <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    <span>ç™»å½•ä¸­...</span>
                `;

                signInAnonymously(auth)
                    .then((result) => {
                        console.log('åŒ¿åç™»å½•æˆåŠŸ');
                        hideLoginModal();
                        showToast('ç™»å½•æˆåŠŸï¼æ¬¢è¿æ¥åˆ°BonkèŠå¤©', 'success');
                    })
                    .catch((error) => {
                        console.error('åŒ¿åç™»å½•å¤±è´¥:', error);
                        showToast('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        anonymousLoginBtn.disabled = false;
                        anonymousLoginBtn.innerHTML = `
                            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center group-hover:bg-white/30 transition-colors">
                                <i class="fa fa-user-secret text-white"></i>
                            </div>
                            <div class="text-left">
                                <div class="font-semibold">åŒ¿åç™»å½•</div>
                                <div class="text-sm opacity-90">å¿«é€Ÿå¼€å§‹èŠå¤©</div>
                            </div>
                            <i class="fa fa-arrow-right ml-auto opacity-60 group-hover:opacity-100 transition-opacity"></i>
                        `;
                    });
            }

            // æ‰§è¡Œé€€å‡ºç™»å½•
            function performLogout() {
                // å…ˆæ›´æ–°ç”¨æˆ·çŠ¶æ€ä¸ºç¦»çº¿
                updateUserStatus('offline');
                
                const { signOut } = window.firebase;
                signOut(auth)
                    .then(() => {
                        console.log('é€€å‡ºç™»å½•æˆåŠŸ');
                        showToast('å·²é€€å‡ºç™»å½•', 'info');
                    })
                    .catch((error) => {
                        console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                        showToast('é€€å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    });
            }

            // é’±åŒ…é€‰æ‹©å¼¹çª—åŠŸèƒ½
            closeWalletSelectModal.addEventListener('click', () => {
                hideWalletSelectModal();
            });

            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            walletSelectModal.addEventListener('click', (e) => {
                if (e.target.id === 'walletSelectModal') {
                    hideWalletSelectModal();
                }
            });

            // æ˜¾ç¤ºé’±åŒ…é€‰æ‹©å¼¹çª—
            function showWalletSelectModal() {
                walletSelectModal.classList.remove('hidden');
                setTimeout(() => {
                    walletSelectModalContent.classList.remove('scale-95', 'opacity-0');
                    walletSelectModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            // éšè—é’±åŒ…é€‰æ‹©å¼¹çª—
            function hideWalletSelectModal() {
                walletSelectModalContent.classList.remove('scale-100', 'opacity-100');
                walletSelectModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    walletSelectModal.classList.add('hidden');
                }, 300);
            }

            // é’±åŒ…æŒ‰é’®äº‹ä»¶
            phantomWalletBtn.addEventListener('click', () => {
                hideWalletSelectModal();
                connectSpecificWallet('phantom');
            });

            okxWalletBtn.addEventListener('click', () => {
                hideWalletSelectModal();
                connectSpecificWallet('okx');
            });

            solflareWalletBtn.addEventListener('click', () => {
                hideWalletSelectModal();
                connectSpecificWallet('solflare');
            });

            // è¿æ¥ç‰¹å®šé’±åŒ…
            function connectSpecificWallet(walletType) {
                console.log('è¿æ¥é’±åŒ…ç±»å‹:', walletType);
                
                // æ˜¾ç¤ºè¿æ¥ä¸­çŠ¶æ€
                showToast(`æ­£åœ¨è¿æ¥${walletType}é’±åŒ…...`, 'info');
                
                window.connectSolanaWallet(walletType).then((address) => {
                    console.log('é’±åŒ…è¿æ¥æˆåŠŸ:', address);
                    showToast(`${walletType}é’±åŒ…è¿æ¥æˆåŠŸï¼`, 'success');
                }).catch((error) => {
                    console.error('é’±åŒ…è¿æ¥å¤±è´¥:', error);
                    showToast(`${walletType}é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                });
            }

            // ç”¨æˆ·æ³¨å†Œå¼¹çª—åŠŸèƒ½
            closeUserRegisterModal.addEventListener('click', () => {
                hideUserRegisterModal();
            });

            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            userRegisterModal.addEventListener('click', (e) => {
                if (e.target.id === 'userRegisterModal') {
                    hideUserRegisterModal();
                }
            });

            // æ˜¾ç¤ºç”¨æˆ·æ³¨å†Œå¼¹çª—
            function showUserRegisterModal() {
                // æ£€æŸ¥æ˜¯å¦ä¸ºé’±åŒ…ç”¨æˆ·
                const walletAddress = window.getSolanaWalletAddress && window.getSolanaWalletAddress();
                const isWalletUser = !!walletAddress;
                
                // æ§åˆ¶å¯†ç ç›¸å…³è¾“å…¥æ¡†æ˜¾ç¤º
                const passwordSection = document.getElementById('passwordInput').parentElement.parentElement;
                const confirmPasswordSection = document.getElementById('confirmPasswordInput').parentElement.parentElement;
                const passwordInput = document.getElementById('passwordInput');
                const confirmPasswordInput = document.getElementById('confirmPasswordInput');
                
                if (isWalletUser) {
                    passwordSection.style.display = 'none';
                    confirmPasswordSection.style.display = 'none';
                    // ç§»é™¤requiredå±æ€§ï¼Œé¿å…è¡¨å•éªŒè¯é”™è¯¯
                    passwordInput.removeAttribute('required');
                    confirmPasswordInput.removeAttribute('required');
                } else {
                    passwordSection.style.display = '';
                    confirmPasswordSection.style.display = '';
                    // æ¢å¤requiredå±æ€§
                    passwordInput.setAttribute('required', '');
                    confirmPasswordInput.setAttribute('required', '');
                }
                
                userRegisterModal.classList.remove('hidden');
                setTimeout(() => {
                    userRegisterModalContent.classList.remove('scale-95', 'opacity-0');
                    userRegisterModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            // éšè—ç”¨æˆ·æ³¨å†Œå¼¹çª—
            function hideUserRegisterModal() {
                userRegisterModalContent.classList.remove('scale-100', 'opacity-100');
                userRegisterModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    userRegisterModal.classList.add('hidden');
                    // é‡æ–°æ˜¾ç¤ºå¯†ç å­—æ®µï¼Œä»¥ä¾¿ä¸‹æ¬¡åŒ¿åç”¨æˆ·æ³¨å†Œæ—¶èƒ½çœ‹åˆ°
                    const passwordSection = document.getElementById('passwordInput').parentElement.parentElement;
                    const confirmPasswordSection = document.getElementById('confirmPasswordInput').parentElement.parentElement;
                    const passwordInput = document.getElementById('passwordInput');
                    const confirmPasswordInput = document.getElementById('confirmPasswordInput');
                    passwordSection.style.display = '';
                    confirmPasswordSection.style.display = '';
                    // æ¢å¤requiredå±æ€§
                    passwordInput.setAttribute('required', '');
                    confirmPasswordInput.setAttribute('required', '');
                }, 300);
            }

            // å¤´åƒä¸Šä¼ åŠŸèƒ½
            avatarPreview.addEventListener('click', () => {
                avatarInput.click();
            });

            avatarInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        validateImageFile(file);
                        uploadAvatar(file);
                    } catch (error) {
                        showToast(error.message, 'error');
                    }
                }
            });

            // å®‰å…¨å·¥å…·å‡½æ•°
            function sanitizeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            function validateInput(input, maxLength = 100) {
                if (typeof input !== 'string') return '';
                return input.trim().substring(0, maxLength);
            }

            function validateImageFile(file) {
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                const maxSize = 5 * 1024 * 1024; // 5MB
                
                if (!allowedTypes.includes(file.type)) {
                    throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹');
                }
                if (file.size > maxSize) {
                    throw new Error('æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶');
                }
                return true;
            }

            // ä¸Šä¼ å¤´åƒ
            function uploadAvatar(file) {
                try {
                    validateImageFile(file);
                } catch (error) {
                    showToast(error.message, 'error');
                    return;
                }
                
                avatarLoading.classList.remove('hidden');
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    // å®‰å…¨åˆ›å»ºå›¾ç‰‡å…ƒç´ ï¼Œé¿å…innerHTMLçš„XSSé£é™©
                    avatarPreview.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = 'å¤´åƒé¢„è§ˆ';
                    img.className = 'w-full h-full rounded-full object-cover';
                    avatarPreview.appendChild(img);
                    avatarLoading.classList.add('hidden');
                };
                reader.onerror = () => {
                    showToast('å¤´åƒåŠ è½½å¤±è´¥', 'error');
                    avatarLoading.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }

            // ç”¨æˆ·åéªŒè¯
            let usernameCheckTimeout = null;
            usernameInput.addEventListener('input', (e) => {
                const username = e.target.value.trim();
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (usernameCheckTimeout) {
                    clearTimeout(usernameCheckTimeout);
                }
                
                // é‡ç½®çŠ¶æ€
                usernameStatus.classList.add('hidden');
                usernameError.classList.add('hidden');
                usernameHint.classList.remove('hidden');
                
                if (username.length >= 2) {
                    // å»¶è¿Ÿæ£€æŸ¥ç”¨æˆ·å
                    usernameCheckTimeout = setTimeout(() => {
                        checkUsernameAvailability(username);
                    }, 500);
                }
            });

            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å¯ç”¨
            async function checkUsernameAvailability(username) {
                try {
                    // éªŒè¯ç”¨æˆ·åæ ¼å¼
                    const cleanUsername = validateInput(username, 20);
                    if (cleanUsername.length < 2) {
                        return;
                    }
                    
                    const usernameRef = ref(database, `usernames/${cleanUsername}`);
                    const snapshot = await get(usernameRef);
                    
                    if (snapshot.exists()) {
                        // ç”¨æˆ·åå·²å­˜åœ¨
                        usernameStatus.classList.add('hidden');
                        usernameError.classList.remove('hidden');
                        usernameHint.classList.add('hidden');
                        registerBtn.disabled = true;
                    } else {
                        // ç”¨æˆ·åå¯ç”¨
                        usernameStatus.classList.remove('hidden');
                        usernameError.classList.add('hidden');
                        usernameHint.classList.add('hidden');
                        registerBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥ç”¨æˆ·åå¤±è´¥:', error);
                }
            }

            // æ ‡ç­¾é€‰æ‹©
            let selectedBadge = 'Bonkçˆ±å¥½è€…';
            badgeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // ç§»é™¤å…¶ä»–æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                    badgeButtons.forEach(b => {
                        b.classList.remove('bg-bonk-orange', 'text-white');
                        b.classList.add('bg-gray-800', 'hover:bg-gray-700');
                    });
                    
                    // æ·»åŠ å½“å‰æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                    btn.classList.remove('bg-gray-800', 'hover:bg-gray-700');
                    btn.classList.add('bg-bonk-orange', 'text-white');
                    
                    selectedBadge = btn.dataset.badge;
                });
            });

            // æ³¨å†Œè¡¨å•æäº¤
            userRegisterForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = usernameInput.value.trim();
                const avatarSrc = avatarPreview.querySelector('img')?.src;
                const walletAddress = window.getSolanaWalletAddress && window.getSolanaWalletAddress();
                const isWalletUser = !!walletAddress;
                let password = '', confirmPassword = '';
                if (!isWalletUser) {
                    password = passwordInput.value;
                    confirmPassword = confirmPasswordInput.value;
                }
                if (!username || username.length < 2) {
                    showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ç”¨æˆ·å', 'error');
                    return;
                }
                if (!isWalletUser) {
                    if (!password || password.length < 6) {
                        showToast('å¯†ç é•¿åº¦è‡³å°‘6ä½', 'error');
                        return;
                    }
                    if (password !== confirmPassword) {
                        showToast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                        return;
                    }
                }
                if (!avatarSrc) {
                    showToast('è¯·ä¸Šä¼ å¤´åƒ', 'error');
                    return;
                }
                // å†æ¬¡æ£€æŸ¥ç”¨æˆ·åå¯ç”¨æ€§
                try {
                    const usernameRef = ref(database, `usernames/${username}`);
                    const snapshot = await get(usernameRef);
                    if (snapshot.exists()) {
                        showToast('ç”¨æˆ·åå·²è¢«ä½¿ç”¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·å', 'error');
                        return;
                    }
                    // å¼€å§‹æ³¨å†Œ
                    await performUserRegistration(username, password, avatarSrc, selectedBadge, isWalletUser);
                } catch (error) {
                    console.error('æ³¨å†Œå¤±è´¥:', error);
                    showToast('æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            });

            // æ‰§è¡Œç”¨æˆ·æ³¨å†Œ
            async function performUserRegistration(username, password, avatarSrc, badge, isWalletUser = false) {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                registerBtn.disabled = true;
                registerBtnText.classList.add('hidden');
                registerBtnLoading.classList.remove('hidden');
                try {
                    let userId;
                    const walletAddress = window.getSolanaWalletAddress && window.getSolanaWalletAddress();
                    if (isWalletUser && walletAddress) {
                        userId = `wallet_${walletAddress}`;
                        console.log('é’±åŒ…ç”¨æˆ·æ³¨å†Œ:', userId);
                    } else {
                        const authResult = await signInAnonymously(auth);
                        userId = authResult.user.uid;
                        console.log('åŒ¿åç”¨æˆ·æ³¨å†Œ:', userId);
                    }
                    // ä¿å­˜ç”¨æˆ·ååˆ°æ•°æ®åº“
                    const usernameRef = ref(database, `usernames/${username}`);
                    await set(usernameRef, {
                        userId: userId,
                        createdAt: Date.now()
                    });
                    // ä¿å­˜ç”¨æˆ·èµ„æ–™
                    const userProfileRef = ref(database, `userProfiles/${userId}`);
                    const profileData = {
                        username: username,
                        avatar: avatarSrc,
                        badge: badge,
                        createdAt: Date.now(),
                        lastSeen: Date.now()
                    };
                    if (isWalletUser && walletAddress) {
                        profileData.walletAddress = walletAddress;
                    } else {
                        // åªæœ‰éé’±åŒ…ç”¨æˆ·æ‰å­˜å¯†ç å“ˆå¸Œ
                        profileData.passwordHash = await hashPassword(password);
                    }
                    await set(userProfileRef, profileData);
                    userProfiles[userId] = {
                        name: username,
                        avatar: avatarSrc,
                        badge: badge
                    };
                    console.log('ç”¨æˆ·æ³¨å†ŒæˆåŠŸ:', userId);
                    hideUserRegisterModal();
                    showToast('æ³¨å†ŒæˆåŠŸï¼æ¬¢è¿æ¥åˆ°BonkèŠå¤©', 'success');
                    updateLoginUI(true);
                    updateUserStatus('online');
                } catch (error) {
                    console.error('ç”¨æˆ·æ³¨å†Œå¤±è´¥:', error);
                    showToast('æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    registerBtn.disabled = false;
                    registerBtnText.classList.remove('hidden');
                    registerBtnLoading.classList.add('hidden');
                }
            }

            // é’±åŒ…è¿æ¥åŠŸèƒ½
            connectWalletBtn.addEventListener('click', () => {
                try {
                    // æ˜¾ç¤ºè¿æ¥ä¸­çŠ¶æ€
                    connectWalletBtn.disabled = true;
                    connectWalletBtn.innerHTML = `
                        <div class="w-4 h-4 border-2 border-bonk-orange border-t-transparent rounded-full animate-spin"></div>
                        <span>è¿æ¥ä¸­...</span>
                    `;
                    
                    // è°ƒç”¨é’±åŒ…è¿æ¥
                    window.connectSolanaWallet().then(() => {
                        // è¿æ¥æˆåŠŸåçš„å¤„ç†åœ¨walletConnectedäº‹ä»¶ä¸­
                    }).catch((error) => {
                        console.error('é’±åŒ…è¿æ¥å¤±è´¥:', error);
                        const errorMessage = error && error.message ? validateInput(error.message, 100) : 'æœªçŸ¥é”™è¯¯';
                        showToast('é’±åŒ…è¿æ¥å¤±è´¥: ' + errorMessage, 'error');
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        connectWalletBtn.disabled = false;
                        connectWalletBtn.innerHTML = `
                            <i class="fa fa-wallet"></i>
                            <span>è¿æ¥é’±åŒ…</span>
                        `;
                    });
                } catch (error) {
                    console.error('é’±åŒ…è¿æ¥åˆå§‹åŒ–å¤±è´¥:', error);
                    showToast('é’±åŒ…è¿æ¥åˆå§‹åŒ–å¤±è´¥', 'error');
                    connectWalletBtn.disabled = false;
                    connectWalletBtn.innerHTML = `
                        <i class="fa fa-wallet"></i>
                        <span>è¿æ¥é’±åŒ…</span>
                    `;
                }
        });

        // è¡¨æƒ…é¢æ¿åˆ‡æ¢
        emojiBtn.addEventListener('click', () => {
            emojiPanel.classList.toggle('hidden');
        });

        // ç‚¹å‡»è¡¨æƒ…æ’å…¥åˆ°è¾“å…¥æ¡†
        emojiButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                messageInput.value += btn.textContent;
                messageInput.focus();
                    updateTypingStatus(true);
            });
        });

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 80) + 'px';
                updateTypingStatus(true);
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (typingTimeout) {
                    clearTimeout(typingTimeout);
                }
                
                // 3ç§’ååœæ­¢è¾“å…¥çŠ¶æ€
                typingTimeout = setTimeout(() => {
                    updateTypingStatus(false);
                }, 3000);
        });

        // å‘é€æ¶ˆæ¯åŠŸèƒ½
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­è¡¨æƒ…é¢æ¿
            document.addEventListener('click', (e) => {
                if (!emojiBtn.contains(e.target) && !emojiPanel.contains(e.target)) {
                    emojiPanel.classList.add('hidden');
                }
            });

            // å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
            imageUploadBtn.addEventListener('click', () => {
                imageInput.click();
            });

            imageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (!currentUser) {
                        showToast('è¯·å…ˆç™»å½•åå†ä¸Šä¼ å›¾ç‰‡', 'warning');
                        showLoginModal();
                        imageInput.value = '';
                        return;
                    }
                    
                    try {
                        validateImageFile(file);
                        uploadImage(file);
                    } catch (error) {
                        showToast(error.message, 'error');
                    } finally {
                        imageInput.value = ''; // æ¸…ç©ºinput
                    }
                }
            });

            // å›¾ç‰‡æ¨¡æ€æ¡†åŠŸèƒ½
            window.openImageModal = function(imageUrl) {
                const modal = document.getElementById('imageModal');
                const modalImage = document.getElementById('modalImage');
                modalImage.src = imageUrl;
                modal.classList.remove('hidden');
            };

            document.getElementById('closeImageModal').addEventListener('click', () => {
                document.getElementById('imageModal').classList.add('hidden');
            });

            document.getElementById('imageModal').addEventListener('click', (e) => {
                if (e.target.id === 'imageModal') {
                    e.target.classList.add('hidden');
                }
            });

            // é¡µé¢å¸è½½æ—¶æ›´æ–°çŠ¶æ€
            window.addEventListener('beforeunload', () => {
                updateUserStatus('offline');
            });

        // åˆå§‹åŒ–ä»·æ ¼å›¾è¡¨
        const ctx = document.getElementById('priceChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(24).fill(''),
                datasets: [{
                    label: 'Bonk Price',
                    data: [0.000051, 0.000053, 0.000052, 0.000050, 0.000049, 0.000050, 0.000052, 0.000054, 
                           0.000055, 0.000057, 0.000056, 0.000055, 0.000057, 0.000059, 0.000060, 0.000059,
                           0.000061, 0.000062, 0.000063, 0.000062, 0.000061, 0.000062, 0.000063, 0.000062],
                    borderColor: '#FF9500',
                    backgroundColor: 'rgba(255, 149, 0, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: false
                    }
                },
                scales: {
                    x: {
                        display: false
                    },
                    y: {
                        display: false
                    }
                },
                elements: {
                    line: {
                        tension: 0.4
                    }
                }
            }
        });

            // å¯åŠ¨åº”ç”¨
            initializeAuth();
            setupPasswordToggles();
            
            // é˜²æ­¢é¡µé¢æ•´ä½“æ»šåŠ¨
            document.addEventListener('wheel', function(e) {
                // å¦‚æœæ»šåŠ¨äº‹ä»¶å‘ç”Ÿåœ¨æ¶ˆæ¯åŒºåŸŸä¹‹å¤–ï¼Œé˜»æ­¢é»˜è®¤è¡Œä¸º
                if (!messageArea.contains(e.target) && !e.target.closest('#messageArea')) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // ç¡®ä¿æ¶ˆæ¯åŒºåŸŸåœ¨é¡µé¢åŠ è½½æ—¶æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                if (messageArea) {
                    messageArea.scrollTop = messageArea.scrollHeight;
                }
            }, 100);
            
            // ç›‘å¬æ¶ˆæ¯åŒºåŸŸçš„æ»šåŠ¨äº‹ä»¶
            messageArea.addEventListener('scroll', () => {
                const { scrollTop, scrollHeight, clientHeight } = messageArea;
                const isAtBottom = scrollTop + clientHeight >= scrollHeight - 10; // 10pxå®¹å·®
                shouldAutoScroll = isAtBottom;
                
                // æ˜¾ç¤ºæˆ–éšè—æ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’®
                if (!isAtBottom && scrollHeight > clientHeight) {
                    scrollToBottomBtn.classList.remove('opacity-0', 'pointer-events-none');
                    scrollToBottomBtn.classList.add('opacity-100', 'pointer-events-auto');
                } else {
                    scrollToBottomBtn.classList.add('opacity-0', 'pointer-events-none');
                    scrollToBottomBtn.classList.remove('opacity-100', 'pointer-events-auto');
                }
            });
            
            // æ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            scrollToBottomBtn.addEventListener('click', () => {
                messageArea.scrollTo({
                    top: messageArea.scrollHeight,
                    behavior: 'smooth'
                });
                shouldAutoScroll = true;
            });

            // å·¦ä¾§èœå•æ "æ­£åœ¨å¼€å‘"æç¤º
            document.querySelectorAll('aside#sidebar nav a').forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    showToast('è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼', 'info');
                });
            });
        }

        // Telegramé£æ ¼æ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’®åŠ¨æ€å®šä½ï¼ˆä¿®æ­£ç‰ˆï¼Œright/bottomï¼‰
        function updateScrollBtnPosition() {
            const messageArea = document.getElementById('messageArea');
            const scrollBtn = document.getElementById('scrollToBottomBtn');
            if (!messageArea || !scrollBtn) return;
            const rect = messageArea.getBoundingClientRect();
            // è®©æŒ‰é’®å¸é™„åœ¨æ¶ˆæ¯åŒºå³ä¸‹è§’ï¼Œå†…ç¼©16px
            scrollBtn.style.position = 'fixed';
            scrollBtn.style.left = '';
            scrollBtn.style.top = '';
            scrollBtn.style.right = (window.innerWidth - rect.right + 16) + 'px';
            scrollBtn.style.bottom = (window.innerHeight - rect.bottom + 16) + 'px';
            // å¦‚æœæ¶ˆæ¯åŒºä¸å¯è§åˆ™éšè—æŒ‰é’®
            if (rect.bottom < 0 || rect.top > window.innerHeight) {
                scrollBtn.style.display = 'none';
            } else {
                scrollBtn.style.display = '';
            }
        }
        window.addEventListener('resize', updateScrollBtnPosition);
        window.addEventListener('scroll', updateScrollBtnPosition);
        setTimeout(updateScrollBtnPosition, 300);


    </script>
    <script src="wallet-connect.js"></script>
</body>
</html>
